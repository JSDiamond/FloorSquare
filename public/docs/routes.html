<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>routes.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>routes.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>All routes for the Floorsquare dashboard and
API. The base url is http://www.itpirl.com/floorsquare.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Define the root (http://www.itpirl.com/floorsquare)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
  <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
  <span class="n">erb</span> <span class="ss">:front</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-SWIPES'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-SWIPES">&#182;</a>
        </div>
        <h2>SWIPES</h2>

<p>Paths for swipe interaction.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Get_swipes_corresponding_to_an_app.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Get_swipes_corresponding_to_an_app.">&#182;</a>
        </div>
        <h3>Get swipes corresponding to an app.</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/swipes/?&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Return as json</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">content_type</span> <span class="ss">:json</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Look for an App matching the specified app_key parameter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:first</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;auth_key = ?&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app_key</span><span class="o">]]</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>If <code>@app</code> is nill, throw a 401 error</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">validate_app_key</span> <span class="vi">@app</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Create a search hash to use as query conditions for Swipes
<code>query</code> is a string with placeholders for conditions
the placeholders are stored in the <code>conditions</code> hash.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;app_id = :app_id&quot;</span>
  <span class="n">conditions</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:app_id</span> <span class="o">=&gt;</span> <span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Restrict search to one device. Useful if an app has multiple devices
and only wants activity from one device.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">[</span><span class="ss">:device_id</span><span class="o">].</span><span class="n">nil?</span>
    <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND device_id = :device_id&quot;</span>
    <span class="n">conditions</span><span class="o">[</span><span class="ss">:device_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:device_id</span><span class="o">]</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Check to see if a specific time range was queried.
If there was no time range specified, return only 50.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:until</span><span class="o">].</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:since</span><span class="o">].</span><span class="n">nil?</span>
    <span class="vi">@swipes</span> <span class="o">=</span> <span class="no">Swipe</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="n">query</span><span class="p">,</span> <span class="n">conditions</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;created_at DESC&quot;</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">)</span>
  <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Append to query to look for swipes with <code>created_at</code> exclusive
less than the parameter.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">[</span><span class="ss">:until</span><span class="o">].</span><span class="n">nil?</span>
      <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND created_at &lt;= :until&quot;</span>
      <span class="n">conditions</span><span class="o">[</span><span class="ss">:until</span><span class="o">]</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:until</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Do the same for <code>since</code>, this is inclusive.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">[</span><span class="ss">:since</span><span class="o">].</span><span class="n">nil?</span>
      <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND created_at &gt;= :since&quot;</span>
      <span class="n">conditions</span><span class="o">[</span><span class="ss">:since</span><span class="o">]</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:since</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Create the query with specified conditions and order by most recent.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="vi">@swipes</span> <span class="o">=</span> <span class="no">Swipe</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:all</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="n">query</span><span class="p">,</span> <span class="n">conditions</span><span class="o">]</span><span class="p">,</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">&quot;created_at DESC&quot;</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>We now have a collection of Swipes stored in <code>@swipes</code> and
need to return them as json which we will do with this loop.
Include the associated User with each Swipe.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">swipe_response</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="vi">@swipes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">swipe</span><span class="o">|</span>
    <span class="n">swipe_response</span> <span class="o">&lt;&lt;</span> <span class="n">swipe</span><span class="o">.</span><span class="n">as_json</span><span class="p">(</span><span class="ss">:include</span> <span class="o">=&gt;</span> <span class="ss">:user</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Allow cross-origin json access</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Finally, return the array of Swipes and ensure it&rsquo;s sent as json.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">swipe_response</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-POST_a_new_swipe.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-POST_a_new_swipe.">&#182;</a>
        </div>
        <h3>POST a new swipe.</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">post</span> <span class="s1">&#39;/swipes/new/?&#39;</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Look for an App matching the specified app_key parameter</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:first</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;auth_key = ?&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app_key</span><span class="o">]]</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>If <code>@app</code> is nill, throw a 401 error</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">validate_app_key</span> <span class="vi">@app</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Find the User that corresponds to the N Number</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:first</span><span class="p">,</span> <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;nnumber = ?&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user_nnumber</span><span class="o">]]</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>If the user is not found, throw 401. Floorsquare is only for ITP.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">throw</span><span class="p">(</span><span class="ss">:halt</span><span class="p">,</span> <span class="o">[</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;User N Number not recognized</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nil?</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Create a new Swipe with the submitted parameters</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="vi">@swipe</span> <span class="o">=</span> <span class="no">Swipe</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
    <span class="ss">:user_nnumber</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user_nnumber</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="ss">:credential</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:credential</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:device_id</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:device_id</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:app_id</span> <span class="o">=&gt;</span> <span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="ss">:extra</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:extra</span><span class="o">]</span> <span class="p">}</span>
  <span class="p">})</span>

  <span class="k">if</span> <span class="vi">@swipe</span><span class="o">.</span><span class="n">save</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">extra</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:first</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">first</span><span class="p">,</span>
      <span class="ss">:last</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
      <span class="ss">:netid</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">netid</span><span class="p">,</span>
      <span class="ss">:photo</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">photo</span><span class="p">,</span>
      <span class="ss">:extra</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">extra</span><span class="o">[</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">:swipeid</span><span class="o">=&gt;</span> <span class="vi">@swipe</span><span class="o">.</span><span class="n">id</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>return JSONP data</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">else</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:halt</span><span class="p">,</span> <span class="o">[</span><span class="mi">401</span><span class="p">,</span> <span class="s2">&quot;Error saving item</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Allows extra data to be added to a swipe, after the swipe occurs.
Makes sense from a user perspective (swipe first, then do something)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">post</span> <span class="s1">&#39;/swipes/:id&#39;</span> <span class="k">do</span>
  <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:auth_key</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app_key</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="n">validate_app_key</span> <span class="vi">@app</span>

  <span class="vi">@swipe</span> <span class="o">=</span> <span class="no">Swipe</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>

  <span class="n">extra</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:extra</span><span class="o">]</span>

  <span class="vi">@swipe</span><span class="o">.</span><span class="n">extra</span> <span class="o">||=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="vi">@swipe</span><span class="o">.</span><span class="n">extra</span><span class="o">[</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span>
    <span class="n">new_extra</span> <span class="o">=</span> <span class="vi">@swipe</span><span class="o">.</span><span class="n">extra</span><span class="o">[</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">].</span><span class="n">merge</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
    <span class="vi">@swipe</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">new_extra</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="vi">@swipe</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">extra</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="vi">@swipe</span><span class="o">.</span><span class="n">save</span>
    <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">return</span> <span class="vi">@swipe</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">else</span>
    <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:halt</span><span class="p">,</span> <span class="o">[</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Error saving item</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-MEMBERS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-MEMBERS">&#182;</a>
        </div>
        <h2>MEMBERS</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Get all users associated with this app</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/members&#39;</span> <span class="k">do</span>
  <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:auth_key</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app_key</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="n">validate_app_key</span> <span class="vi">@app</span>

  <span class="n">user_ids</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="vi">@app</span><span class="o">.</span><span class="n">swipes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">swipe</span><span class="o">|</span>
    <span class="n">user_ids</span> <span class="o">&lt;&lt;</span> <span class="n">swipe</span><span class="o">.</span><span class="n">user_id</span>
  <span class="k">end</span>

  <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>

  <span class="vi">@users</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>Get a specific member</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/members/:nnumber&#39;</span> <span class="k">do</span>
  <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:auth_key</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app_key</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="n">validate_app_key</span> <span class="vi">@app</span>

  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:nnumber</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:nnumber</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>

  <span class="n">extra</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:extra</span><span class="o">]</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="vi">@user</span>
    <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:halt</span><span class="p">,</span> <span class="o">[</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Member not found</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">extra</span>
      <span class="n">new_extra</span><span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">extra</span><span class="o">[</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">].</span><span class="n">merge</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">new_extra</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;app_id_</span><span class="si">#{</span><span class="vi">@app</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">=&gt;</span> <span class="n">extra</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
      <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
      <span class="k">return</span> <span class="vi">@user</span><span class="o">.</span><span class="n">to_json</span>
    <span class="k">else</span>
      <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
      <span class="kp">throw</span><span class="p">(</span><span class="ss">:halt</span><span class="p">,</span> <span class="o">[</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Error saving User</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Get the swipes belonging to a member</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/members/:nnumber/swipes&#39;</span> <span class="k">do</span>
  <span class="vi">@app</span> <span class="o">=</span> <span class="no">App</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:auth_key</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:app_key</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="n">validate_app_key</span> <span class="vi">@app</span>

  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:nnumber</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:nnumber</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="vi">@user</span>
    <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:halt</span><span class="p">,</span> <span class="o">[</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;Member not found</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">response</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">return</span> <span class="vi">@user</span><span class="o">.</span><span class="n">swipes</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-SASS'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-SASS">&#182;</a>
        </div>
        <h2>SASS</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/stylesheets/style.css&#39;</span> <span class="k">do</span>
  <span class="n">scss</span> <span class="ss">:style</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-404'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-404">&#182;</a>
        </div>
        <h2>404</h2>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">not_found</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:notfound</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
